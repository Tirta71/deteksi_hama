{% extends 'base.html' %} {% block title %}SIMASHA - Upload & Deteksi{% endblock
%} {% block content %}
<div class="row g-4">
  <!-- Upload -->
  <div class="col-md-4">
    <div class="card shadow-sm h-full">
      <div class="card-body">
        <h5 class="card-title mb-3">Upload Gambar</h5>

        <div
          class="ratio ratio-16x9 rounded overflow-hidden border mb-3 bg-light"
        >
          <img
            id="livePreview"
            src=""
            alt="Preview"
            class="w-100 h-100"
            style="object-fit: cover; display: none"
          />
        </div>

        <form id="uploadForm" class="input-group">
          <input
            type="file"
            id="fileInput"
            name="file"
            accept="image/*"
            class="d-none"
          />
          <label for="fileInput" class="btn btn-outline-secondary"
            >Choose File</label
          >
          <input
            type="text"
            id="fileName"
            class="form-control"
            placeholder="No file chosen"
            readonly
          />
          <button class="btn btn-primary" type="submit">
            Upload & Deteksi
          </button>
        </form>

        <hr />
        <a
          href="{{ url_for('hasil_deteksi') }}"
          class="btn btn-outline-primary w-100"
        >
          <i class="bi bi-table"></i> Lihat Hasil Deteksi
        </a>
      </div>
    </div>
  </div>

  <!-- Input (canvas) + Crop preview -->
  <div class="col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title">Input Without Augmentation</h5>
        <div class="media-640 mb-3">
          <canvas id="canvas"></canvas>
        </div>

        <h5 class="card-title mt-3">Input With Augmentation</h5>
        <div class="media-640 position-relative">
          <img id="cropped" src="" alt="Hasil crop" />
          <div
            id="cropLoader"
            class="position-absolute top-50 start-50 translate-middle bg-dark bg-opacity-50 text-white px-3 py-1 rounded d-none"
          >
            Memproses...
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Predictions -->
  <div class="col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title">Prediction Without Augmentation</h5>
        <div class="media-640 mb-2 position-relative">
          <img
            id="yolo_full"
            src="data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAA="
            alt="Hasil YOLO Full"
            loading="lazy"
          />
        </div>

        <h5 class="card-title mt-3">Prediction With Augmentation</h5>
        <div class="media-640 mb-2 position-relative">
          <img
            id="yolo_crop"
            src="data:image/gif;base64,R0lGODlhAQABAAAAACwAAAAAAQABAAA="
            alt="Hasil YOLO Crop"
            loading="lazy"
          />
          <div
            id="yoloLoader"
            class="position-absolute top-50 start-50 translate-middle bg-dark bg-opacity-50 text-white px-3 py-1 rounded d-none"
          >
            Deteksi...
          </div>
        </div>

        <div class="d-grid">
          <button id="resetBtn" class="btn btn-warning">ðŸ”„ Reset</button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  const uploadForm = document.getElementById("uploadForm");
  const fileInput = document.getElementById("fileInput");
  const fileNameEl = document.getElementById("fileName");
  const livePrev = document.getElementById("livePreview");

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  const imgSrc = new Image();
  const cropped = document.getElementById("cropped");

  const yoloFull = document.getElementById("yolo_full");
  const yoloCrop = document.getElementById("yolo_crop");
  const yoloLoader = document.getElementById("yoloLoader");
  const resetBtn = document.getElementById("resetBtn");

  let cropBlob = null; // <--- simpan blob JPEG crop di sini
  let cropURL = ""; // preview URL untuk blob (revoke jika ada)
  let lastObjectUrl = "";

  // pilih file â†’ preview & sumber canvas
  fileInput.addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    // batasi ukuran visual di client? opsional, kita biarkan apa adanya

    // revoke url lama
    if (lastObjectUrl) URL.revokeObjectURL(lastObjectUrl);
    lastObjectUrl = URL.createObjectURL(file);

    fileNameEl.value = file.name;
    livePrev.src = lastObjectUrl;
    livePrev.style.display = "block";
    imgSrc.src = lastObjectUrl;

    // reset crop
    if (cropURL) URL.revokeObjectURL(cropURL);
    cropURL = "";
    cropBlob = null;
    cropped.src = "";
  });

  // canvas: sizing & drawing
  let isDown = false,
    startX = 0,
    startY = 0,
    curX = 0,
    curY = 0,
    cw = 0,
    ch = 0;

  function fitCanvasToBox() {
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    cw = rect.width;
    ch = rect.height;
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  }
  function redraw(showSel) {
    ctx.clearRect(0, 0, cw, ch);
    if (imgSrc.src) ctx.drawImage(imgSrc, 0, 0, cw, ch);
    if (showSel && isDown) {
      const x = Math.min(startX, curX),
        y = Math.min(startY, curY);
      const w = Math.abs(curX - startX),
        h = Math.abs(curY - startY);
      ctx.save();
      ctx.strokeStyle = "#ff4107";
      ctx.lineWidth = 2;
      ctx.setLineDash([6, 4]);
      ctx.strokeRect(x, y, w, h);
      ctx.setLineDash([]);
      ctx.restore();
    }
  }
  imgSrc.onload = () => {
    fitCanvasToBox();
    redraw(false);
  };
  window.addEventListener("resize", () => {
    fitCanvasToBox();
    redraw(isDown);
  });

  canvas.addEventListener("mousedown", (e) => {
    // reset crop setiap mulai seleksi baru
    if (cropURL) URL.revokeObjectURL(cropURL);
    cropURL = "";
    cropBlob = null;
    cropped.src = "";

    const r = canvas.getBoundingClientRect();
    startX = curX = Math.max(0, Math.min(cw, e.clientX - r.left));
    startY = curY = Math.max(0, Math.min(ch, e.clientY - r.top));
    isDown = true;
    canvas.style.cursor = "nwse-resize";
    redraw(true);
  });
  canvas.addEventListener("mousemove", (e) => {
    if (!isDown) return;
    const r = canvas.getBoundingClientRect();
    curX = Math.max(0, Math.min(cw, e.clientX - r.left));
    curY = Math.max(0, Math.min(ch, e.clientY - r.top));
    redraw(true);
  });
  window.addEventListener("mouseup", () => {
    if (!isDown) return;
    isDown = false;
    canvas.style.cursor = "crosshair";
    const x = Math.min(startX, curX),
      y = Math.min(startY, curY);
    const w = Math.abs(curX - startX),
      h = Math.abs(curY - startY);
    if (w < 3 || h < 3) {
      redraw(false);
      return;
    }

    const scaleX = imgSrc.naturalWidth / cw;
    const scaleY = imgSrc.naturalHeight / ch;
    const sx = Math.round(x * scaleX),
      sy = Math.round(y * scaleY);
    const sw = Math.round(w * scaleX),
      sh = Math.round(h * scaleY);

    const temp = document.createElement("canvas");
    temp.width = sw;
    temp.height = sh;
    temp.getContext("2d").drawImage(imgSrc, sx, sy, sw, sh, 0, 0, sw, sh);

    const fixed = document.createElement("canvas");
    fixed.width = 640;
    fixed.height = 640;
    fixed.getContext("2d").drawImage(temp, 0, 0, 640, 640);

    // >>> PENTING: kirim sebagai BLOB JPEG, bukan dataURL <<<
    fixed.toBlob(
      (blob) => {
        if (!blob) return;
        cropBlob = blob; // simpan untuk FormData
        if (cropURL) URL.revokeObjectURL(cropURL);
        cropURL = URL.createObjectURL(blob);
        cropped.src = cropURL; // preview
      },
      "image/jpeg",
      0.75
    ); // kompres 75%
    redraw(false);
  });

  // submit: kirim FILE + (opsional) Blob crop â†’ tampilkan barengan
  uploadForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const file = fileInput.files?.[0];
    if (!file) {
      alert("Pilih file dulu.");
      return;
    }

    const fd = new FormData();
    fd.append("file", file);

    // kirim crop dalam FIELD 'crop' kalau ada
    if (cropBlob) {
      fd.append("crop", cropBlob, "crop.jpg");
    }

    // UI loading
    const btn = uploadForm.querySelector('button[type="submit"]');
    const oldLabel = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = "Memproses...";
    yoloFull.style.visibility = "hidden";
    yoloCrop.style.visibility = "hidden";
    yoloLoader.classList.remove("d-none");

    try {
      const res = await fetch("/detect_both", { method: "POST", body: fd });
      const out = await res.json();
      if (out.status !== "success") {
        alert("âŒ Gagal deteksi: " + (out.message || ""));
        return;
      }
      const bust = (u) => u + (u.includes("?") ? "&" : "?") + "t=" + Date.now();
      if (out.yolo_full) yoloFull.src = bust(out.yolo_full);
      if (out.yolo_crop) yoloCrop.src = bust(out.yolo_crop);
      yoloFull.style.visibility = "visible";
      yoloCrop.style.visibility = "visible";
    } catch (e) {
      alert("Terjadi error saat proses deteksi.");
      console.error(e);
    } finally {
      yoloLoader.classList.add("d-none");
      btn.disabled = false;
      btn.innerHTML = oldLabel;
    }
  });

  document.getElementById("resetBtn").addEventListener("click", () => {
    location.href = "/";
  });
</script>
{% endblock %}
